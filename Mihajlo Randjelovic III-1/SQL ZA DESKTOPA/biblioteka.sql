USE MASTER;
CREATE DATABASE BIBLIOTEKA;
CREATE TABLE CITATLAC(
	CITALAC_ID INT PRIMARY KEY IDENTITY(1,1),
	MATICNI_BROJ CHAR(13) NOT NULL,
	IME CHAR(30) NOT NULL,
	PREZIME CHAR(30) NOT NULL,
	MESTO CHAR(30) NOT NULL,
	ADRESA CHAR(30) NOT NULL,
	TELEFON CHAR(30) NOT NULL,
);
CREATE TABLE NA_CITANJU(
	KNJIGA_ID INT,
	CITALAC_ID INT,
	DATUM_IZDAVANJA DATE,
	DATUM_VRACANJA DATE,
	PRIMARY KEY(KNJIGA_ID,CITALAC_ID,DATUM_IZDAVANJA),
	FOREIGN KEY (CITALAC_ID) REFERENCES CITATLAC(CITALAC_ID),
	FOREIGN KEY (KNJIGA_ID) REFERENCES KNJIGA(KNJIGA_ID),
);

CREATE TABLE KNJIGA(
	KNJIGA_ID INT PRIMARY KEY IDENTITY(1,1),
	UDK INT NOT NULL,
	ISBN INT NOT NULL,
	NAZIV CHAR(30) NOT NULL,
);

INSERT INTO KNJIGA VALUES
(1,1,'Ana karenjina'),
(2,2,'Tom sojer'),
(3,3,'Robinson Kruso');

INSERT INTO CITATLAC VALUES
('1','Elon','Musk','Amerika','Ulica Republike','06666666666'),
('2','Darko','Jevtic','Smederevo','Ulica Marka Kraljevica','06666666667'),
('3','Zarko','Jevtic','Beograd','Ulica Kralja Aleksandra','06666666668');

INSERT INTO NA_CITANJU VALUES 
(1,1,'1/1/2022',NULL),
(2,2,'2/2/2022','10/2/2022'),
(3,3,'3/2/2022',NULL),
(2,1,'2/2/2022','10/2/2022'),
(3,1,'10/11/2021','12/31/2021');

/*
	SASATAVITI STORE PROCEDURU KOJA SADRZI SLEDECE SQL UPITE
	1.Prikazati podatke o citaocima (citlac_id,ime,prezime) broj nevracenih knjiga za sve citaoce koji duguju vise od @K knjiga
	2.Prikazati citalac_id,ime,p,knjiga_id,naziv,datum_uzimanja za sve nevracene knjige sortirano po datumu uzimanja i citalac_id po rastucem poretku
*/
SELECT C.CITALAC_ID,C.IME,C.PREZIME,COUNT(KNJIGA_ID) AS BR 
FROM NA_CITANJU N LEFT JOIN CITATLAC C ON N.CITALAC_ID=C.CITALAC_ID 
WHERE N.DATUM_VRACANJA IS NULL 
GROUP BY C.CITALAC_ID,C.IME,C.PREZIME;

SELECT C.CITALAC_ID,C.IME,C.PREZIME,K.KNJIGA_ID,K.NAZIV,N.DATUM_IZDAVANJA 
FROM ((NA_CITANJU AS N INNER JOIN CITATLAC AS C
ON N.CITALAC_ID=C.CITALAC_ID) JOIN KNJIGA K
ON K.KNJIGA_ID=N.CITALAC_ID)
WHERE DATUM_VRACANJA IS NULL
ORDER BY DATUM_IZDAVANJA,CITALAC_ID ASC;

